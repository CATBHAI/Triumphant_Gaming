<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Triumphant Tournament Auction</title>
<style>

:root {
  --bg: #050816;
  --card: #0f172a;
  --accent: #38bdf8;
  --accent-soft: rgba(56,189,248,0.15);
  --accent-strong: #f97316;
  --text: #e5e7eb;
  --muted: #9ca3af;
  --danger: #f97373;
  --success: #4ade80;
  --border: #1f2937;
  --radius-lg: 18px;
  --radius-pill: 999px;
  --shadow-soft: 0 18px 45px rgba(0,0,0,0.55);
}

body {
  margin:0;
  background: radial-gradient(circle at top, #1f2937 0, #020617 45%, #000 100%);
  color: var(--text);
  font-family: system-ui, sans-serif;
}

.app {
  max-width: 1300px;
  margin: 20px auto 80px;
  padding: 0 16px;
}

/* HEADER */

header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:14px;
  margin-bottom:20px;
}

header h1 {
  margin:0;
  font-size:1.9rem;
  display:flex;
  align-items:center;
  gap:8px;
}

header .subtitle {
  font-size:0.9rem;
  color:var(--muted);
}

/* Undo + Export buttons */

.top-buttons {
  display:flex;
  gap:10px;
}

.top-btn {
  padding:8px 16px;
  border-radius:var(--radius-pill);
  background:rgba(15,23,42,0.8);
  border:1px solid rgba(148,163,184,0.4);
  color:var(--text);
  font-size:0.8rem;
  cursor:pointer;
  transition:0.15s;
}

.top-btn:hover {
  background:rgba(30,41,59,0.9);
  transform:translateY(-2px);
}

/* CARD */

.card {
  background: radial-gradient(circle at top left, #1e293b 0, #020617 60%);
  border-radius:var(--radius-lg);
  border:1px solid var(--border);
  box-shadow: var(--shadow-soft);
  padding:16px;
  margin-bottom:20px;
}

.card-title {
  font-weight:bold;
  font-size:1rem;
  margin-bottom:14px;
}

/* GRID */

main {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}

@media(max-width:900px){
  main { grid-template-columns:1fr; }
}

/* CAPTAINS */

.captain-list {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
  gap:10px;
}

.captain {
  padding:10px;
  border-radius:12px;
  background:rgba(15,23,42,0.6);
  border:1px solid rgba(31,41,55,0.8);
}

.captain-name { font-weight:bold; }
.credits { color:var(--accent); font-weight:bold; }

/* CURRENT PLAYER */

.current-player-box {
  padding:14px;
  background:rgba(15,23,42,0.6);
  border-radius:12px;
  border:1px solid rgba(31,41,55,0.8);
}

.current-name { font-size:1.25rem; font-weight:bold; }
.current-meta { font-size:0.85rem; color:var(--muted); margin-bottom:8px; }

/* BID FORM */

.bid-box {
  padding:14px;
  background:rgba(15,23,42,0.6);
  border:1px solid rgba(31,41,55,0.8);
  border-radius:12px;
}

input, select {
  background:#020617;
  border:1px solid rgba(55,65,81,0.9);
  color:white;
  padding:6px;
  border-radius:8px;
  font-size:0.9rem;
}

button {
  border:none;
  border-radius:12px;
  padding:8px 12px;
  font-size:0.85rem;
  cursor:pointer;
  margin-right:6px;
}

.btn-main { background:var(--accent); color:black; }
.btn-secondary { background:rgba(30,41,59,0.9); color:var(--muted); }
.btn-danger { background:#ef4444; color:white; }

/* PLAYER GRID */

.players-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(130px,1fr));
  gap:10px;
}

.player-card {
  background:rgba(15,23,42,0.6);
  border:1px solid rgba(31,41,55,0.9);
  border-radius:10px;
  padding:10px;
  cursor:pointer;
}

.player-card.sold { background:rgba(22,101,52,0.3); border-color:#22c55e; }
.player-card.unsold { background:rgba(127,29,29,0.3); border-color:#ef4444; }
.player-card.current { border-color:var(--accent); }

/* SPIN WHEEL */

.wheel-container {
  display:flex;
  justify-content:center;
  align-items:center;
  margin-top:20px;
}

canvas#wheelCanvas {
  width:450px;
  height:450px;
  border-radius:50%;
  background:#111827;
  border:6px solid var(--accent);
  box-shadow:0 0 25px rgba(56,189,248,0.4);
}

.wheel-wrapper {
  position: relative;
  width: 450px;
  height: 450px;
  margin: 0 auto;
}

.pointer {
  position: absolute;
  top: 50%;
  right: -22px;                   /* stays on the right side */
  transform: translateY(-50%);
  width: 0;
  height: 0;
  border-top: 18px solid transparent;
  border-bottom: 18px solid transparent;
  border-right: 30px solid #f8fafc;  /* ‚úî POINTS LEFT (into wheel) */
  filter: drop-shadow(0 0 8px rgba(255,255,255,0.6));
}




.spin-btn {
  margin-top:10px;
  background:var(--accent);
  color:black;
  padding:10px 18px;
  border-radius:var(--radius-pill);
  cursor:pointer;
  font-weight:bold;
}

</style>
</head>

<body>
<div class="app">

<header>
  <div>
    <h1>üèÜ Triumphant Tournament Auction</h1>
    <div class="subtitle">
      Captains have 2000 credits. 1 player per tier. Spin wheel decides who goes to auction.
    </div>
  </div>

  <div class="top-buttons">
    <button class="top-btn" id="undoBtn">‚Ü© Undo</button>
    <button class="top-btn" id="exportBtn">‚¨á Export Results</button>
  </div>
</header>

<main>

  <!-- CAPTAINS -->
  <section class="card">
    <div class="card-title">Captains (Tier 2 - not in auction)</div>
    <div id="captainList" class="captain-list"></div>
  </section>

  <!-- CURRENT PLAYER & BIDDING -->
  <section class="card">
    <div class="card-title">Current Auction</div>

    <div class="current-player-box" id="currentPlayerBox"></div>

    <br>

    <div class="bid-box">
      <label>Captain:</label>
      <select id="captainSelect"></select><br><br>

      <label>Bid Amount:</label>
      <input type="number" id="bidAmount" min="0"/><br><br>

      <button class="btn-main" id="placeBidBtn">üí∞ Place / Raise Bid</button>
      <button class="btn-secondary" id="sellBtn">‚úÖ Complete Sale</button>
      <button class="btn-danger" id="unsoldBtn">üö´ Mark Unsold</button>

      <div id="currentBidText" style="margin-top:10px;font-size:0.85rem;"></div>
      <div id="bidHistory" style="margin-top:6px;font-size:0.8rem;color:var(--muted);"></div>
    </div>

  </section>

</main>

<!-- PLAYER GRID -->
<section class="card">
  <div class="card-title">Players</div>
  <div id="playersGrid" class="players-grid"></div>
</section>

<!-- SPIN WHEEL -->
<section class="card">
  <div class="card-title">üé° Spin the Wheel</div>

  <label>Select Tier:</label>
  <select id="wheelTierSelect">
    <option value="1">Tier 1</option>
    <option value="3">Tier 3</option>
    <option value="4">Tier 4</option>
    <option value="5">Tier 5</option>
  </select>

  <button class="spin-btn" id="spinButton">SPIN</button>

  <div class="wheel-wrapper">
  <canvas id="wheelCanvas" width="450" height="450"></canvas>
  <div class="pointer"></div>
  </div>


  <p id="spinResult" style="text-align:center;margin-top:8px;color:var(--accent);font-weight:bold;">
    Waiting for spin...
  </p>
</section>

</div> <!-- app -->

<script>
/* ===========================
   AUCTION DATA
=========================== */

const tiersConfig = {
  1: { minBid: 500, inc: 100, penalty: 400 },
  3: { minBid: 300, inc: 70, penalty: 250 },
  4: { minBid: 200, inc: 50, penalty: 150 },
  5: { minBid: 100, inc: 20, penalty: 100 }
};

const captains = [
  { name: "Zawad", credits: 2000, roster: [], purchases:{1:null,3:null,4:null,5:null}},
  { name: "Ponir", credits: 2000, roster: [], purchases:{1:null,3:null,4:null,5:null}},
  { name: "Rohan", credits: 2000, roster: [], purchases:{1:null,3:null,4:null,5:null}},
  { name: "Arique", credits: 2000, roster: [], purchases:{1:null,3:null,4:null,5:null}}
];

// Auction pool (NO Tier 2)
const players = [
  {name:"Digonto", tier:1, sold:false, unsold:false, owner:null},
  {name:"Anik", tier:1, sold:false, unsold:false, owner:null},
  {name:"H Rafi", tier:1, sold:false, unsold:false, owner:null},
  {name:"Salty", tier:1, sold:false, unsold:false, owner:null},

  {name:"Amit", tier:3, sold:false, unsold:false, owner:null},
  {name:"Moon", tier:3, sold:false, unsold:false, owner:null},
  {name:"Joy", tier:3, sold:false, unsold:false, owner:null},
  {name:"Naif", tier:3, sold:false, unsold:false, owner:null},

  {name:"Rafi", tier:4, sold:false, unsold:false, owner:null},
  {name:"Swaccho", tier:4, sold:false, unsold:false, owner:null},
  {name:"Rhaiyan", tier:4, sold:false, unsold:false, owner:null},
  {name:"Rizwan", tier:4, sold:false, unsold:false, owner:null},

  {name:"Tama", tier:5, sold:false, unsold:false, owner:null},
  {name:"Semanto", tier:5, sold:false, unsold:false, owner:null},
  {name:"Nafi", tier:5, sold:false, unsold:false, owner:null},
  {name:"Hridoy", tier:5, sold:false, unsold:false, owner:null}
];

/* ===========================
   GLOBAL STATE
=========================== */

let currentPlayer = null;
let currentBid = null;  // { captain, amount }
let bidHistory = [];
let undoStack = [];

function getCaptain(name){ return captains.find(c=>c.name===name); }
function getPlayer(name){ return players.find(p=>p.name===name); }
function currency(n){ return n+" TK"; }

/* ===========================
   RENDER CAPTAINS
=========================== */

function renderCaptains(){
  const div = document.getElementById("captainList");
  div.innerHTML = "";

  captains.forEach(c => {
    const card = document.createElement("div");
    card.className = "captain";

    card.innerHTML = `
      <div class="captain-name">${c.name}</div>
      <div class="credits">${currency(c.credits)}</div>
      <div style="font-size:0.75rem;margin-top:8px;">
        T1: ${c.purchases[1] || "‚Äî"}<br>
        T3: ${c.purchases[3] || "‚Äî"}<br>
        T4: ${c.purchases[4] || "‚Äî"}<br>
        T5: ${c.purchases[5] || "‚Äî"}
      </div>
    `;

    div.appendChild(card);
  });

  const select = document.getElementById("captainSelect");
  select.innerHTML = "";
  captains.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c.name;
    opt.textContent = `${c.name} (${currency(c.credits)})`;
    select.appendChild(opt);
  });
}

/* ===========================
   RENDER CURRENT PLAYER
=========================== */

function renderCurrentPlayer(){
  const box = document.getElementById("currentPlayerBox");
  if (!currentPlayer){
    box.innerHTML = `<div style="color:var(--muted);font-size:0.9rem;">No player selected</div>`;
    document.getElementById("currentBidText").textContent = "";
    document.getElementById("bidHistory").innerHTML = "";
    return;
  }

  const t = currentPlayer.tier;

  box.innerHTML = `
    <div class="current-name">${currentPlayer.name}</div>
    <div class="current-meta">
      Tier ${t} ‚Ä¢ Base ${currency(tiersConfig[t].minBid)} ‚Ä¢ Min Inc ${currency(tiersConfig[t].inc)}
    </div>
  `;

  renderBidBox();
}

function renderBidBox(){
  const t = document.getElementById("currentBidText");
  if(!currentPlayer){
    t.textContent = "";
    return;
  }

  if(!currentBid){
    t.textContent = "No bids yet.";
  } else {
    t.textContent = `Highest Bid: ${currentBid.captain} ‚Üí ${currency(currentBid.amount)}`;
  }

  const h = document.getElementById("bidHistory");
  h.innerHTML = bidHistory.map(b=>`${b.captain}: ${currency(b.amount)}`).join("<br>");
}

/* ===========================
   RENDER PLAYER GRID
=========================== */

function renderPlayers(){
  const grid = document.getElementById("playersGrid");
  grid.innerHTML = "";

  players.forEach(p=>{
    const card = document.createElement("div");
    card.className = "player-card";

    if(p.sold) card.classList.add("sold");
    if(p.unsold) card.classList.add("unsold");
    if(currentPlayer && currentPlayer.name === p.name) card.classList.add("current");

    card.innerHTML = `
      <div>${p.name}</div>
      <div style="font-size:0.75rem;color:var(--muted);">Tier ${p.tier}</div>
      <div style="font-size:0.75rem;margin-top:4px;">
        ${p.sold ? "Sold to "+p.owner : p.unsold ? "Unsold" : "Available"}
      </div>
    `;

    if(!p.sold && !p.unsold){
      card.addEventListener("click", ()=>{
        undoStack.push({action:"setPlayer", prev: currentPlayer});
        currentPlayer = p;
        currentBid = null;
        bidHistory = [];
        renderCurrentPlayer();
        renderPlayers();
      });
    }

    grid.appendChild(card);
  });
}

/* ===========================
   BIDDING
=========================== */

document.getElementById("placeBidBtn").addEventListener("click", ()=>{
  if(!currentPlayer){
    alert("No player selected.");
    return;
  }
  if(currentPlayer.sold || currentPlayer.unsold){
    alert("This player is already closed.");
    return;
  }

  const capName = document.getElementById("captainSelect").value;
  const cap = getCaptain(capName);
  const amount = parseInt(document.getElementById("bidAmount").value);

  if(isNaN(amount) || amount <= 0){
    alert("Invalid bid.");
    return;
  }
  if(cap.purchases[currentPlayer.tier]){
    alert(`${cap.name} already bought a Tier ${currentPlayer.tier} player.`);
    return;
  }
  if(amount > cap.credits){
    alert(cap.name + " doesn't have enough credits.");
    return;
  }

  // extra safety: keep enough to buy remaining tiers' base prices
  const remainingTiers = [1,3,4,5].filter(
    t => t !== currentPlayer.tier && !cap.purchases[t]
  );
  const reserve = remainingTiers.reduce(
    (sum,t)=>sum+tiersConfig[t].minBid, 0
  );
  if (cap.credits - amount < reserve){
    alert(`${cap.name} must keep at least ${currency(reserve)} to buy remaining tiers.`);
    return;
  }

  const cfg = tiersConfig[currentPlayer.tier];

  if(!currentBid){
    if(amount < cfg.minBid){
      alert("Bid must start at least " + currency(cfg.minBid));
      return;
    }
  } else {
    if(amount < currentBid.amount + cfg.inc){
      alert("Minimum raise is " + currency(cfg.inc));
      return;
    }
  }

  // Save undo
  undoStack.push({
    action: "bid",
    prev: JSON.parse(JSON.stringify({currentBid,bidHistory}))
  });

  currentBid = {captain:cap.name, amount};
  bidHistory.push({captain:cap.name, amount});
  renderBidBox();
});

document.getElementById("sellBtn").addEventListener("click", ()=>{
  if(!currentPlayer || !currentBid){
    alert("No bid to finalize.");
    return;
  }
  const cap = getCaptain(currentBid.captain);
  if(currentBid.amount > cap.credits){
    alert("Captain no longer has enough credits.");
    return;
  }

  undoStack.push({
    action:"sell",
    prev: JSON.parse(JSON.stringify({player:currentPlayer, cap}))
  });

  cap.credits -= currentBid.amount;
  cap.purchases[currentPlayer.tier] = currentPlayer.name;
  cap.roster.push(currentPlayer.name);

  currentPlayer.sold = true;
  currentPlayer.owner = cap.name;

  currentBid = null;
  bidHistory = [];

  renderCaptains();
  renderCurrentPlayer();
  renderPlayers();
});

document.getElementById("unsoldBtn").addEventListener("click", ()=>{
  if(!currentPlayer) return;
  if(currentPlayer.sold || currentPlayer.unsold) return;

  undoStack.push({action:"unsold", prev:currentPlayer});

  currentPlayer.unsold = true;
  currentBid = null;
  bidHistory = [];

  renderCurrentPlayer();
  renderPlayers();
});

/* ===========================
   SPIN WHEEL CANVAS
=========================== */

const wheelCanvas = document.getElementById("wheelCanvas");
const ctx = wheelCanvas.getContext("2d");

let wheelPlayers = [];       // players shown on wheel (names AND order)
let wheelAngle = 0;          // current rotation
let highlightedIndex = -1;   // glowing slice index
let spinning = false;

// draw wheel with current wheelPlayers & highlight
function drawWheel() {
  const names = wheelPlayers.map(p => p.name);
  const total = names.length || 1;
  const slice = (2*Math.PI)/total;

  ctx.clearRect(0,0,450,450);

  names.forEach((n,i)=>{
    const start = i * slice;
    const end   = start + slice;

    // slice
    ctx.beginPath();
    ctx.moveTo(225,225);
    ctx.arc(225,225,220,start,end);
    ctx.closePath();
    ctx.fillStyle = i%2===0 ? "#1e3a8a" : "#0f172a";
    ctx.fill();

    // glow highlight on winner
    if (i === highlightedIndex) {
      ctx.save();
      ctx.shadowColor = "#0ff";
      ctx.shadowBlur = 35;
      ctx.lineWidth = 6;
      ctx.strokeStyle = "rgba(34,211,238,0.9)";
      ctx.stroke();
      ctx.restore();
    }

    // text
    ctx.save();
    ctx.translate(225,225);
    ctx.rotate(start + slice/2);
    ctx.textAlign = "left";
    ctx.fillStyle="#fff";
    ctx.font="16px sans-serif";
    ctx.fillText(n, 140, 5);
    ctx.restore();
  });
}


function easeOutCubic(t){ return 1 - Math.pow(1-t,3); }

function spinWheel(){
  if (spinning) return;

  const tier = parseInt(document.getElementById("wheelTierSelect").value, 10);

  // show ALL remaining players from this tier on the wheel (including H Rafi)
  wheelPlayers = players.filter(p => p.tier === tier && !p.sold && !p.unsold);

  if (wheelPlayers.length === 0) {
    document.getElementById("spinResult").textContent = "No players left.";
    ctx.clearRect(0,0,450,450);
    return;
  }

  // --- RIGGING: choose winner index (but not H Rafi unless he's last) ---
  let candidateIndices;
  if (tier === 1) {
    candidateIndices = wheelPlayers
      .map((p, idx) => p.name === "H Rafi" ? null : idx)
      .filter(idx => idx !== null);

    if (candidateIndices.length === 0) {
      // only H Rafi left
      candidateIndices = [0];
    }
  } else {
    candidateIndices = wheelPlayers.map((_, idx) => idx);
  }

  const winnerIndex = candidateIndices[Math.floor(Math.random() * candidateIndices.length)];
  const winner = wheelPlayers[winnerIndex];

  // rotation math: pointer is on the RIGHT side (angle = 0 rad)
  const total = wheelPlayers.length;
  const slice = (2 * Math.PI) / total;
  const sliceCenter = (winnerIndex + 0.5) * slice;  // center angle of winning slice
  const pointerAngle = 0;                            // right side
  const extraSpins = 4;                              // full rotations
  const finalAngle = pointerAngle - sliceCenter + extraSpins * 2 * Math.PI;

  highlightedIndex = -1;      // reset glow
  spinning = true;
  document.getElementById("spinResult").textContent = "Spinning...";

  const startTime = performance.now();
  const duration = 2800;

  function animate(now){
    const t = (now - startTime) / duration;

    if (t < 1) {
      const eased = easeOutCubic(Math.min(1, t));
      const angle = finalAngle * eased;   // always start from 0 ‚Üí full spins

      ctx.save();
      ctx.translate(225,225);
      ctx.rotate(angle);
      ctx.translate(-225,-225);
      drawWheel();                        // uses wheelPlayers + highlightedIndex
      ctx.restore();

      requestAnimationFrame(animate);
    } else {
      highlightedIndex = winnerIndex;

      ctx.save();
      ctx.translate(225,225);
      ctx.rotate(finalAngle);
      ctx.translate(-225,-225);
      drawWheel();
      ctx.restore();

      spinning = false;
      document.getElementById("spinResult").textContent =
        `Selected: ${winner.name}`;

      // allow undo of spin
      undoStack.push({ action: "spin", prev: currentPlayer });

      currentPlayer = winner;
      currentBid = null;
      bidHistory = [];
      renderCurrentPlayer();
      renderPlayers();
    }
  }

  requestAnimationFrame(animate);
}

document.getElementById("spinButton").addEventListener("click", spinWheel);


/* ===========================
   UNDO
=========================== */

document.getElementById("undoBtn").addEventListener("click", ()=>{
  if(undoStack.length===0){
    alert("Nothing to undo.");
    return;
  }

  const last = undoStack.pop();

  if(last.action==="setPlayer"){
    currentPlayer = last.prev;
  }
  if(last.action==="bid"){
    currentBid = last.prev.currentBid;
    bidHistory = last.prev.bidHistory;
  }
  if(last.action==="sell"){
    const p = last.prev.player;
    const c = last.prev.cap;

    let playerObj = getPlayer(p.name);
    let captainObj = getCaptain(c.name);

    // revert
    playerObj.sold = false;
    playerObj.owner = null;
    captainObj.credits = c.credits;
    captainObj.purchases[p.tier] = null;
    captainObj.roster = captainObj.roster.filter(x=>x!==p.name);
  }
  if(last.action==="unsold"){
    last.prev.unsold = false;
  }
  if(last.action==="spin"){
    currentPlayer = last.prev;
    currentBid = null;
    bidHistory = [];
  }

  renderCaptains();
  renderPlayers();
  renderCurrentPlayer();
});

/* ===========================
   EXPORT RESULTS
=========================== */

document.getElementById("exportBtn").addEventListener("click", ()=>{
  const data = {
    captains,
    players,
    timestamp: new Date().toISOString()
  };

  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "auction_results.json";
  a.click();

  URL.revokeObjectURL(url);
});

/* ===========================
   INIT
=========================== */

renderCaptains();
renderPlayers();
renderCurrentPlayer();

// initial blank wheel (Tier 3 by default)
wheelPlayers = players.filter(p=>p.tier===3 && !p.sold && !p.unsold);
ctx.save();
ctx.translate(225,225);
ctx.rotate(wheelAngle);
ctx.translate(-225,-225);
drawWheel();
ctx.restore();
</script>
</body>
</html>

