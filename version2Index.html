<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Triumphant Tournament Auction</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #020617;
  --bg-alt: #020617;
  --card: #020617;
  --accent: #38bdf8;
  --accent-soft: rgba(56,189,248,0.15);
  --accent-strong: #f97316;
  --text: #e5e7eb;
  --muted: #9ca3af;
  --danger: #f97373;
  --success: #4ade80;
  --border: #1f2937;
  --radius-lg: 18px;
  --radius-pill: 999px;
  --shadow-soft: 0 18px 45px rgba(15,23,42,0.9);
}

* {
  box-sizing: border-box;
}

body {
  margin:0;
  min-height:100vh;
  background:
    radial-gradient(circle at top left, #1e293b 0, transparent 55%),
    radial-gradient(circle at bottom right, #0f172a 0, #020617 55%);
  color: var(--text);
  font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

.app {
  max-width: 1300px;
  margin: 16px auto 80px;
  padding: 0 18px 40px;
}

/* HEADER */

header {
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  flex-wrap:wrap;
  gap:16px;
  margin-bottom:20px;
}

header h1 {
  margin:0;
  font-size:2rem;
  display:flex;
  align-items:center;
  gap:10px;
  letter-spacing:0.03em;
}

header h1 span {
  font-size:2.2rem;
}

header .subtitle {
  margin-top:4px;
  font-size:0.88rem;
  color:var(--muted);
}

/* Undo + Export buttons */

.top-buttons {
  display:flex;
  gap:10px;
}

.top-btn {
  padding:8px 16px;
  border-radius:var(--radius-pill);
  background:rgba(15,23,42,0.9);
  border:1px solid rgba(148,163,184,0.5);
  color:var(--text);
  font-size:0.8rem;
  cursor:pointer;
  transition:0.15s;
  display:inline-flex;
  align-items:center;
  gap:6px;
}

.top-btn:hover {
  background:rgba(30,64,175,0.8);
  border-color:rgba(191,219,254,0.7);
  transform:translateY(-1px);
  box-shadow:0 10px 25px rgba(30,64,175,0.45);
}

/* CARD */

.card {
  background: radial-gradient(circle at top left, rgba(30,64,175,0.18) 0, #020617 52%);
  border-radius:var(--radius-lg);
  border:1px solid rgba(15,23,42,0.95);
  box-shadow: var(--shadow-soft);
  padding:14px 16px 18px;
  margin-bottom:20px;
  position:relative;
  overflow:hidden;
}

.card::before{
  content:"";
  position:absolute;
  inset:-40%;
  background:
    radial-gradient(circle at top, rgba(56,189,248,0.16), transparent 55%),
    radial-gradient(circle at bottom right, rgba(96,165,250,0.18), transparent 60%);
  opacity:0.35;
  pointer-events:none;
}

.card > * {
  position:relative;
  z-index:1;
}

.card-title {
  font-weight:600;
  font-size:1rem;
  margin-bottom:14px;
  display:flex;
  align-items:center;
  gap:8px;
}

.card-title::before{
  content:"";
  width:6px;
  height:18px;
  border-radius:999px;
  background:linear-gradient(180deg,#38bdf8,#22c55e);
}

/* GRID */

main {
  display:grid;
  grid-template-columns: minmax(0,1.05fr) minmax(0,1.05fr);
  gap:16px;
}

@media(max-width:900px){
  main { grid-template-columns:1fr; }
}

/* CAPTAINS */

.captain-list {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
  gap:10px;
}

.captain {
  padding:10px 12px;
  border-radius:14px;
  background:linear-gradient(135deg,rgba(15,23,42,0.9),rgba(15,23,42,0.75));
  border:1px solid rgba(31,41,55,0.9);
  box-shadow:0 10px 24px rgba(15,23,42,0.6);
}

.captain-name { font-weight:600; }
.credits { color:var(--accent); font-weight:600; font-size:0.85rem; margin-top:3px; }

.captain small {
  display:block;
  margin-top:8px;
  font-size:0.72rem;
  color:var(--muted);
  line-height:1.4;
}

/* CURRENT PLAYER */

.current-player-box {
  padding:14px 14px 10px;
  background:linear-gradient(145deg,rgba(15,23,42,0.96),rgba(15,23,42,0.8));
  border-radius:14px;
  border:1px solid rgba(31,41,55,0.95);
  margin-bottom:12px;
}

.current-name { font-size:1.25rem; font-weight:600; }
.current-meta { font-size:0.82rem; color:var(--muted); margin-top:4px; margin-bottom:10px; }

/* BID FORM */

.bid-box {
  padding:14px;
  background:rgba(15,23,42,0.9);
  border:1px solid rgba(31,41,55,0.95);
  border-radius:14px;
}

input, select {
  background:#020617;
  border:1px solid rgba(55,65,81,0.9);
  color:white;
  padding:6px 8px;
  border-radius:8px;
  font-size:0.86rem;
  outline:none;
}

input:focus, select:focus {
  border-color:var(--accent);
  box-shadow:0 0 0 1px rgba(56,189,248,0.5);
}

button {
  border:none;
  border-radius:var(--radius-pill);
  padding:7px 13px;
  font-size:0.8rem;
  cursor:pointer;
  margin-right:6px;
  font-weight:500;
  display:inline-flex;
  align-items:center;
  gap:4px;
  transition:0.12s ease;
}

button:active{
  transform:translateY(0);
  box-shadow:none;
}

.btn-main {
  background:var(--accent);
  color:#020617;
  box-shadow:0 12px 28px rgba(56,189,248,0.45);
}
.btn-main:hover{
  background:#0ea5e9;
  transform:translateY(-1px);
}

.btn-secondary {
  background:rgba(30,64,175,0.85);
  color:#e5e7eb;
  box-shadow:0 10px 22px rgba(30,64,175,0.4);
}
.btn-secondary:hover{
  background:rgba(59,130,246,0.9);
  transform:translateY(-1px);
}

.btn-danger {
  background:#ef4444;
  color:white;
  box-shadow:0 12px 26px rgba(248,113,113,0.55);
}
.btn-danger:hover{
  background:#f97373;
  transform:translateY(-1px);
}

#currentBidText{
  margin-top:10px;
  font-size:0.8rem;
}
#bidHistory{
  margin-top:4px;
  font-size:0.78rem;
  color:var(--muted);
}

/* PLAYER GRID */

.players-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:10px;
}

.player-card {
  background:linear-gradient(135deg,rgba(15,23,42,0.95),rgba(15,23,42,0.8));
  border:1px solid rgba(31,41,55,0.95);
  border-radius:12px;
  padding:10px 11px;
  cursor:pointer;
  transition:0.14s;
  position:relative;
}

.player-card::after{
  content:"";
  position:absolute;
  inset:-1px;
  border-radius:inherit;
  border:1px solid transparent;
  pointer-events:none;
}

.player-card:hover:not(.sold):not(.unsold){
  transform:translateY(-2px);
  box-shadow:0 16px 32px rgba(15,23,42,0.95);
  border-color:rgba(37,99,235,0.8);
}

.player-card.sold {
  background:linear-gradient(135deg,rgba(22,163,74,0.9),rgba(5,46,22,0.95));
  border-color:#22c55e;
}
.player-card.unsold {
  background:linear-gradient(135deg,rgba(185,28,28,0.9),rgba(69,10,10,0.95));
  border-color:#f97373;
}
.player-card.current::after{
  border-color:rgba(56,189,248,0.9);
  box-shadow:0 0 18px rgba(56,189,248,0.75);
}

.player-card-title{
  font-size:0.9rem;
  font-weight:500;
}
.player-card-sub{
  font-size:0.74rem;
  color:var(--muted);
}
.player-card-status{
  margin-top:4px;
  font-size:0.74rem;
}

/* SPIN WHEEL */

.wheel-container {
  display:flex;
  justify-content:center;
  align-items:center;
  margin-top:18px;
}

canvas#wheelCanvas {
  width:450px;
  height:450px;
  border-radius:50%;
  background:radial-gradient(circle at 30% 20%, #1e293b 0, #020617 60%);
  border:6px solid #38bdf8;
  box-shadow:
    0 0 35px rgba(56,189,248,0.7),
    0 0 80px rgba(15,23,42,0.9);
}

.wheel-wrapper {
  position: relative;
  width: 450px;
  height: 450px;
  margin: 0 auto;
}

/* pointer on the right, pointing left */
.pointer {
  position: absolute;
  top: 50%;
  right: -26px;
  transform: translateY(-50%);
  width: 0;
  height: 0;
  border-top: 18px solid transparent;
  border-bottom: 18px solid transparent;
  border-right: 32px solid #f9fafb;
  filter: drop-shadow(0 0 9px rgba(255,255,255,0.8));
}

/* center hub of wheel (visual, drawn via pseudo-element) */
.wheel-wrapper::after{
  content:"";
  position:absolute;
  width:80px;
  height:80px;
  border-radius:50%;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  background:radial-gradient(circle at 30% 20%, #f9fafb 0, #cbd5f5 40%, #1e40af 100%);
  box-shadow:
    0 0 20px rgba(248,250,252,0.7),
    0 0 60px rgba(59,130,246,0.7) inset;
}

/* spin button */

.spin-btn {
  margin-left:8px;
  margin-bottom:4px;
  background:linear-gradient(135deg,#38bdf8,#10b981);
  color:#020617;
  padding:8px 18px;
  border-radius:var(--radius-pill);
  cursor:pointer;
  font-weight:600;
  font-size:0.8rem;
  box-shadow:0 12px 30px rgba(34,197,94,0.55);
}
.spin-btn:hover{
  transform:translateY(-1px);
  filter:brightness(1.05);
}

#spinResult{
  text-align:center;
  margin-top:10px;
  color:#7dd3fc;
  font-weight:600;
  font-size:0.85rem;
  letter-spacing:0.02em;
}


/* small label for spin section */
label {
  font-size:0.82rem;
  color:var(--muted);
}
</style>
</head>

<body>
<div class="app">

<header>
  <div>
    <h1><span>üèÜ</span>Triumphant Tournament Auction</h1>
    <div class="subtitle">
      Captains have 2000 credits ‚Ä¢ 1 player per tier ‚Ä¢ Spin the wheel to decide who goes to auction.
    </div>
  </div>

  <div class="top-buttons">
    <button class="top-btn" id="undoBtn">‚Ü© Undo</button>
    <button class="top-btn" id="exportBtn">‚¨á Export Results</button>
  </div>
</header>

<main>
  <!-- CAPTAINS -->
  <section class="card">
    <div class="card-title">Captains (Tier 2 ‚Äì excluded from player pool)</div>
    <div id="captainList" class="captain-list"></div>
  </section>

  <!-- CURRENT PLAYER & BIDDING -->
  <section class="card">
    <div class="card-title">Current Auction</div>

    <div class="current-player-box" id="currentPlayerBox"></div>

    <div class="bid-box">
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
        <div style="flex:1;min-width:180px;">
          <label>Captain</label><br>
          <select id="captainSelect" style="width:100%;margin-top:4px;"></select>
        </div>
        <div style="flex:1;min-width:140px;">
          <label>Bid Amount</label><br>
          <input type="number" id="bidAmount" min="0" style="width:100%;margin-top:4px;"/>
        </div>
      </div>

      <div style="margin-bottom:6px;">
        <button class="btn-main" id="placeBidBtn">üí∞ Place / Raise Bid</button>
        <button class="btn-secondary" id="sellBtn">‚úÖ Complete Sale</button>
        <button class="btn-danger" id="unsoldBtn">üö´ Mark Unsold</button>
      </div>

      <div id="currentBidText"></div>
      <div id="bidHistory"></div>
    </div>
  </section>
</main>

<!-- PLAYER GRID -->
<section class="card">
  <div class="card-title">Players</div>
  <div id="playersGrid" class="players-grid"></div>
</section>

<!-- SPIN WHEEL -->
<section class="card">
  <div class="card-title">üé° Spin the Wheel</div>

  <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
    <label for="wheelTierSelect">Select Tier:</label>
    <select id="wheelTierSelect">
      <option value="1">Tier 1</option>
      <option value="3">Tier 3</option>
      <option value="4">Tier 4</option>
      <option value="5">Tier 5</option>
    </select>
    <button class="spin-btn" id="spinButton">SPIN</button>
  </div>

  <div class="wheel-wrapper">
    <canvas id="wheelCanvas" width="450" height="450"></canvas>
    <div class="pointer"></div>
  </div>

  <p id="spinResult">Waiting for spin...</p>
</section>

</div> <!-- app -->

<script>
/* ===========================
   AUCTION DATA
=========================== */

const tiersConfig = {
  1: { minBid: 500, inc: 100, penalty: 400 },
  3: { minBid: 300, inc: 70, penalty: 250 },
  4: { minBid: 200, inc: 50, penalty: 150 },
  5: { minBid: 100, inc: 20, penalty: 100 }
};

const captains = [
  { name: "Zawad", credits: 2000, roster: [], purchases:{1:null,3:null,4:null,5:null}},
  { name: "Ponir", credits: 2000, roster: [], purchases:{1:null,3:null,4:null,5:null}},
  { name: "Rohan", credits: 2000, roster: [], purchases:{1:null,3:null,4:null,5:null}},
  { name: "Arique", credits: 2000, roster: [], purchases:{1:null,3:null,4:null,5:null}}
];

// Auction pool (NO Tier 2)
const players = [
  {name:"Digonto", tier:1, sold:false, unsold:false, owner:null},
  {name:"Anik", tier:1, sold:false, unsold:false, owner:null},
  {name:"H Rafi", tier:1, sold:false, unsold:false, owner:null},
  {name:"Salty", tier:1, sold:false, unsold:false, owner:null},

  {name:"Amit", tier:3, sold:false, unsold:false, owner:null},
  {name:"Moon", tier:3, sold:false, unsold:false, owner:null},
  {name:"Joy", tier:3, sold:false, unsold:false, owner:null},
  {name:"Naif", tier:3, sold:false, unsold:false, owner:null},

  {name:"Rafi", tier:4, sold:false, unsold:false, owner:null},
  {name:"Swaccho", tier:4, sold:false, unsold:false, owner:null},
  {name:"Rhaiyan", tier:4, sold:false, unsold:false, owner:null},
  {name:"Rizwan", tier:4, sold:false, unsold:false, owner:null},

  {name:"Tama", tier:5, sold:false, unsold:false, owner:null},
  {name:"Semanto", tier:5, sold:false, unsold:false, owner:null},
  {name:"Nafi", tier:5, sold:false, unsold:false, owner:null},
  {name:"Hridoy", tier:5, sold:false, unsold:false, owner:null}
];

/* ===========================
   GLOBAL STATE
=========================== */

let currentPlayer = null;
let currentBid = null;  // { captain, amount }
let bidHistory = [];
let undoStack = [];

function getCaptain(name){ return captains.find(c=>c.name===name); }
function getPlayer(name){ return players.find(p=>p.name===name); }
function currency(n){ return n+" TK"; }

/* ===========================
   RENDER CAPTAINS
=========================== */

function renderCaptains(){
  const div = document.getElementById("captainList");
  div.innerHTML = "";

  captains.forEach(c => {
    const card = document.createElement("div");
    card.className = "captain";

    card.innerHTML = `
      <div class="captain-name">${c.name}</div>
      <div class="credits">${currency(c.credits)}</div>
      <small>
        T1: ${c.purchases[1] || "‚Äî"}<br>
        T3: ${c.purchases[3] || "‚Äî"}<br>
        T4: ${c.purchases[4] || "‚Äî"}<br>
        T5: ${c.purchases[5] || "‚Äî"}
      </small>
    `;

    div.appendChild(card);
  });

  const select = document.getElementById("captainSelect");
  select.innerHTML = "";
  captains.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c.name;
    opt.textContent = `${c.name} (${currency(c.credits)})`;
    select.appendChild(opt);
  });
}

/* ===========================
   RENDER CURRENT PLAYER
=========================== */

function renderCurrentPlayer(){
  const box = document.getElementById("currentPlayerBox");
  if (!currentPlayer){
    box.innerHTML = `<div style="color:var(--muted);font-size:0.9rem;">No player selected yet. Spin the wheel or click a card.</div>`;
    document.getElementById("currentBidText").textContent = "";
    document.getElementById("bidHistory").innerHTML = "";
    return;
  }

  const t = currentPlayer.tier;

  box.innerHTML = `
    <div class="current-name">${currentPlayer.name}</div>
    <div class="current-meta">
      Tier ${t} ‚Ä¢ Base ${currency(tiersConfig[t].minBid)} ‚Ä¢ Min Inc ${currency(tiersConfig[t].inc)}
    </div>
  `;

  renderBidBox();
}

function renderBidBox(){
  const t = document.getElementById("currentBidText");
  if(!currentPlayer){
    t.textContent = "";
    return;
  }

  if(!currentBid){
    t.textContent = "No bids yet.";
  } else {
    t.textContent = `Highest Bid: ${currentBid.captain} ‚Üí ${currency(currentBid.amount)}`;
  }

  const h = document.getElementById("bidHistory");
  h.innerHTML = bidHistory.map(b=>`${b.captain}: ${currency(b.amount)}`).join("<br>");
}

/* ===========================
   RENDER PLAYER GRID
=========================== */

function renderPlayers(){
  const grid = document.getElementById("playersGrid");
  grid.innerHTML = "";

  players.forEach(p=>{
    const card = document.createElement("div");
    card.className = "player-card";

    if(p.sold) card.classList.add("sold");
    if(p.unsold) card.classList.add("unsold");
    if(currentPlayer && currentPlayer.name === p.name) card.classList.add("current");

    card.innerHTML = `
      <div class="player-card-title">${p.name}</div>
      <div class="player-card-sub">Tier ${p.tier}</div>
      <div class="player-card-status">
        ${p.sold ? "Sold to "+p.owner : p.unsold ? "Unsold" : "Available"}
      </div>
    `;

    if(!p.sold && !p.unsold){
      card.addEventListener("click", ()=>{
        undoStack.push({action:"setPlayer", prev: currentPlayer});
        currentPlayer = p;
        currentBid = null;
        bidHistory = [];
        renderCurrentPlayer();
        renderPlayers();
      });
    }

    grid.appendChild(card);
  });
}

/* ===========================
   BIDDING
=========================== */

document.getElementById("placeBidBtn").addEventListener("click", ()=>{
  if(!currentPlayer){
    alert("No player selected.");
    return;
  }
  if(currentPlayer.sold || currentPlayer.unsold){
    alert("This player is already closed.");
    return;
  }

  const capName = document.getElementById("captainSelect").value;
  const cap = getCaptain(capName);
  const amount = parseInt(document.getElementById("bidAmount").value);

  if(isNaN(amount) || amount <= 0){
    alert("Invalid bid.");
    return;
  }
  if(cap.purchases[currentPlayer.tier]){
    alert(`${cap.name} already bought a Tier ${currentPlayer.tier} player.`);
    return;
  }
  if(amount > cap.credits){
    alert(cap.name + " doesn't have enough credits.");
    return;
  }

  // must keep enough credits to still buy remaining tiers (base prices)
  const remainingTiers = [1,3,4,5].filter(
    t => t !== currentPlayer.tier && !cap.purchases[t]
  );
  const reserve = remainingTiers.reduce(
    (sum,t)=>sum+tiersConfig[t].minBid, 0
  );
  if (cap.credits - amount < reserve){
    alert(`${cap.name} must keep at least ${currency(reserve)} to buy remaining tiers.`);
    return;
  }

  const cfg = tiersConfig[currentPlayer.tier];

  if(!currentBid){
    if(amount < cfg.minBid){
      alert("Bid must start at least " + currency(cfg.minBid));
      return;
    }
  } else {
    if(amount < currentBid.amount + cfg.inc){
      alert("Minimum raise is " + currency(cfg.inc));
      return;
    }
  }

  undoStack.push({
    action: "bid",
    prev: JSON.parse(JSON.stringify({currentBid,bidHistory}))
  });

  currentBid = {captain:cap.name, amount};
  bidHistory.push({captain:cap.name, amount});
  renderBidBox();
});

document.getElementById("sellBtn").addEventListener("click", ()=>{
  if(!currentPlayer || !currentBid){
    alert("No bid to finalize.");
    return;
  }
  const cap = getCaptain(currentBid.captain);
  if(currentBid.amount > cap.credits){
    alert("Captain no longer has enough credits.");
    return;
  }

  undoStack.push({
    action:"sell",
    prev: JSON.parse(JSON.stringify({player:currentPlayer, cap}))
  });

  cap.credits -= currentBid.amount;
  cap.purchases[currentPlayer.tier] = currentPlayer.name;
  cap.roster.push(currentPlayer.name);

  currentPlayer.sold = true;
  currentPlayer.owner = cap.name;

  currentBid = null;
  bidHistory = [];

  renderCaptains();
  renderCurrentPlayer();
  renderPlayers();
});

document.getElementById("unsoldBtn").addEventListener("click", ()=>{
  if(!currentPlayer) return;
  if(currentPlayer.sold || currentPlayer.unsold) return;

  undoStack.push({action:"unsold", prev:currentPlayer});

  currentPlayer.unsold = true;
  currentBid = null;
  bidHistory = [];

  renderCurrentPlayer();
  renderPlayers();
});

/* ===========================
   SPIN WHEEL CANVAS
=========================== */

const wheelCanvas = document.getElementById("wheelCanvas");
const ctx = wheelCanvas.getContext("2d");

let wheelPlayers = [];       // players shown on wheel (names + order)
let wheelAngle = 0;          // current rotation
let highlightedIndex = -1;   // glowing slice index
let spinning = false;

// palette of slice colors
const sliceColors = [
  "#0ea5e9",
  "#8b5cf6",
  "#22c55e",
  "#f97316",
  "#ec4899",
  "#eab308",
  "#38bdf8",
  "#14b8a6"
];

// draw wheel with current wheelPlayers & highlight
function drawWheel() {
  const names = wheelPlayers.map(p => p.name);
  const total = names.length || 1;
  const slice = (2*Math.PI)/total;

  ctx.clearRect(0,0,450,450);

  names.forEach((n,i)=>{
    const start = i * slice;
    const end   = start + slice;

    // slice
    ctx.beginPath();
    ctx.moveTo(225,225);
    ctx.arc(225,225,210,start,end);
    ctx.closePath();
    ctx.fillStyle = sliceColors[i % sliceColors.length];
    ctx.fill();

    // subtle inner border
    ctx.save();
    ctx.lineWidth = 1.4;
    ctx.strokeStyle = "rgba(15,23,42,0.65)";
    ctx.stroke();
    ctx.restore();

    // glow highlight on winner
    if (i === highlightedIndex) {
      ctx.save();
      ctx.lineWidth = 4;
      ctx.strokeStyle = "rgba(248,250,252,0.95)";
      ctx.shadowColor = "#e0f2fe";
      ctx.shadowBlur = 26;
      ctx.stroke();
      ctx.restore();
    }

    // text
    ctx.save();
    ctx.translate(225,225);
    ctx.rotate(start + slice/2);
    ctx.textAlign = "left";
    ctx.fillStyle="#0b1120";
    ctx.font="bold 16px Poppins, sans-serif";
    ctx.fillText(n, 115, 5);
    ctx.restore();
  });
}

function easeOutCubic(t){ return 1 - Math.pow(1-t,3); }

function spinWheel(){
  if (spinning) return;

  const tier = parseInt(document.getElementById("wheelTierSelect").value, 10);

  // show ALL remaining players from this tier on the wheel (including H Rafi)
  wheelPlayers = players.filter(p => p.tier === tier && !p.sold && !p.unsold);

  if (wheelPlayers.length === 0) {
    document.getElementById("spinResult").textContent = "No players left in this tier.";
    ctx.clearRect(0,0,450,450);
    return;
  }

  // --- RIGGING: choose winner index (but not H Rafi unless he's last) ---
  let candidateIndices;
  if (tier === 1) {
    candidateIndices = wheelPlayers
      .map((p, idx) => p.name === "H Rafi" ? null : idx)
      .filter(idx => idx !== null);

    if (candidateIndices.length === 0) {
      // only H Rafi left
      candidateIndices = [0];
    }
  } else {
    candidateIndices = wheelPlayers.map((_, idx) => idx);
  }

  const winnerIndex = candidateIndices[Math.floor(Math.random() * candidateIndices.length)];
  const winner = wheelPlayers[winnerIndex];

  // rotation math: pointer is on the RIGHT side (angle = 0 rad)
  const total = wheelPlayers.length;
  const slice = (2 * Math.PI) / total;
  const sliceCenter = (winnerIndex + 0.5) * slice;  // center angle of winning slice
  const pointerAngle = 0;                            // right side
  const extraSpins = 4;                              // full rotations
  const finalAngle = pointerAngle - sliceCenter + extraSpins * 2 * Math.PI;

  highlightedIndex = -1;      // reset glow
  spinning = true;
  document.getElementById("spinResult").textContent = "Spinning...";

  const startTime = performance.now();
  const duration = 2800;

  function animate(now){
    const t = (now - startTime) / duration;

    if (t < 1) {
      const eased = easeOutCubic(Math.min(1, t));
      const angle = finalAngle * eased;

      ctx.save();
      ctx.translate(225,225);
      ctx.rotate(angle);
      ctx.translate(-225,-225);
      drawWheel();
      ctx.restore();

      requestAnimationFrame(animate);
    } else {
      highlightedIndex = winnerIndex;

      ctx.save();
      ctx.translate(225,225);
      ctx.rotate(finalAngle);
      ctx.translate(-225,-225);
      drawWheel();
      ctx.restore();

      spinning = false;
      document.getElementById("spinResult").textContent =
        `Selected: ${winner.name}`;

      undoStack.push({ action: "spin", prev: currentPlayer });

      currentPlayer = winner;
      currentBid = null;
      bidHistory = [];
      renderCurrentPlayer();
      renderPlayers();
    }
  }

  requestAnimationFrame(animate);
}

document.getElementById("spinButton").addEventListener("click", spinWheel);

/* ===========================
   UNDO
=========================== */

document.getElementById("undoBtn").addEventListener("click", ()=>{
  if(undoStack.length===0){
    alert("Nothing to undo.");
    return;
  }

  const last = undoStack.pop();

  if(last.action==="setPlayer"){
    currentPlayer = last.prev;
  }
  if(last.action==="bid"){
    currentBid = last.prev.currentBid;
    bidHistory = last.prev.bidHistory;
  }
  if(last.action==="sell"){
    const p = last.prev.player;
    const c = last.prev.cap;

    let playerObj = getPlayer(p.name);
    let captainObj = getCaptain(c.name);

    playerObj.sold = false;
    playerObj.owner = null;
    captainObj.credits = c.credits;
    captainObj.purchases[p.tier] = null;
    captainObj.roster = captainObj.roster.filter(x=>x!==p.name);
  }
  if(last.action==="unsold"){
    last.prev.unsold = false;
  }
  if(last.action==="spin"){
    currentPlayer = last.prev;
    currentBid = null;
    bidHistory = [];
  }

  renderCaptains();
  renderPlayers();
  renderCurrentPlayer();
});

/* ===========================
   EXPORT RESULTS
=========================== */

document.getElementById("exportBtn").addEventListener("click", ()=>{
  const data = {
    captains,
    players,
    timestamp: new Date().toISOString()
  };

  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "auction_results.json";
  a.click();

  URL.revokeObjectURL(url);
});

/* ===========================
   INIT
=========================== */

renderCaptains();
renderPlayers();
renderCurrentPlayer();

// initial wheel (show Tier 3 just as a default visual)
wheelPlayers = players.filter(p=>p.tier===3 && !p.sold && !p.unsold);
drawWheel();
</script>
</body>
</html>
